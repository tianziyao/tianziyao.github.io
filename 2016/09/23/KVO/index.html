<!doctype html>



  


<html class="theme-next pisces use-motion">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>



<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />












  
  
  <link href="/vendors/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  
    
      
    

    
  

  

  
    
      
    

    
  

  
    
      
    

    
  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Monda:300,300italic,400,400italic,700,700italic|Roboto Slab:300,300italic,400,400italic,700,700italic|Lobster Two:300,300italic,400,400italic,700,700italic|PT Mono:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/vendors/font-awesome/css/font-awesome.min.css?v=4.4.0" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.0.1" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="设计模式,KVO," />





  <link rel="alternate" href="/atom.xml" title="iSTian'notes" type="application/atom+xml" />




  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.0.1" />






<meta name="description" content="KVO/KVC是观察者模式在Objective-C中的实现，以非正式协议（Category）的形式被定义在NSObject中。从协议的角度看，是定义了一套让开发者遵守的规范和使用的方法。
在Cocoa的MVC框架中，KVO架起ViewController和Model沟通的桥梁，例如：

代码中，在模型类A创建属性数据，在控制器中创建观察者，一旦属性数据发生改变就收到观察者收到通知，通过KVO再在控">
<meta property="og:type" content="article">
<meta property="og:title" content="iOS设计模式 - KVO原理和使用">
<meta property="og:url" content="http://yoursite.com/2016/09/23/KVO/index.html">
<meta property="og:site_name" content="iSTian'notes">
<meta property="og:description" content="KVO/KVC是观察者模式在Objective-C中的实现，以非正式协议（Category）的形式被定义在NSObject中。从协议的角度看，是定义了一套让开发者遵守的规范和使用的方法。
在Cocoa的MVC框架中，KVO架起ViewController和Model沟通的桥梁，例如：

代码中，在模型类A创建属性数据，在控制器中创建观察者，一旦属性数据发生改变就收到观察者收到通知，通过KVO再在控">
<meta property="og:updated_time" content="2016-09-22T16:28:04.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="iOS设计模式 - KVO原理和使用">
<meta name="twitter:description" content="KVO/KVC是观察者模式在Objective-C中的实现，以非正式协议（Category）的形式被定义在NSObject中。从协议的角度看，是定义了一套让开发者遵守的规范和使用的方法。
在Cocoa的MVC框架中，KVO架起ViewController和Model沟通的桥梁，例如：

代码中，在模型类A创建属性数据，在控制器中创建观察者，一旦属性数据发生改变就收到观察者收到通知，通过KVO再在控">



<script type="text/javascript" id="hexo.configuration">
  var NexT = window.NexT || {};
  var CONFIG = {
    scheme: 'Pisces',
    sidebar: {"position":"left","display":"post"},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: 0,
      author: '博主'
    }
  };
</script>




  <link rel="canonical" href="http://yoursite.com/2016/09/23/KVO/"/>

  <title> iOS设计模式 - KVO原理和使用 | iSTian'notes </title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  










  
  
    
  

  <div class="container one-collumn sidebar-position-left page-post-detail ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-meta ">
  

  <div class="custom-logo-site-title">
    <a href="/"  class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <span class="site-title">iSTian'notes</span>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>
  <p class="site-subtitle">Quick notes</p>
</div>

<div class="site-nav-toggle">
  <button>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
  </button>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            关于
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      

      
    </ul>
  

  
</nav>

 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                iOS设计模式 - KVO原理和使用
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2016-09-23T02:24:00+08:00" content="2016-09-23">
              2016-09-23
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/iOS/" itemprop="url" rel="index">
                    <span itemprop="name">iOS</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2016/09/23/KVO/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2016/09/23/KVO/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        <p>KVO/KVC是观察者模式在Objective-C中的实现，以非正式协议（Category）的形式被定义在NSObject中。从协议的角度看，是定义了一套让开发者遵守的规范和使用的方法。</p>
<p>在Cocoa的MVC框架中，KVO架起ViewController和Model沟通的桥梁，例如：</p>
<blockquote>
<p>代码中，在模型类A创建属性数据，在控制器中创建观察者，一旦属性数据发生改变就收到观察者收到通知，通过KVO再在控制器使用回调方法处理实现视图B的更新。</p>
</blockquote>
   <a id="more"></a>
<h2 id="实现原理"><a href="#实现原理" class="headerlink" title="实现原理"></a>实现原理</h2><p>当观察某对象A时，KVO机制动态创建一个对象A当前类的子类，并为这个新的子类重写了被观察属性keyPath的setter方法，setter方法随后负责通知观察对象属性的改变状况。Apple使用了：</p>
<blockquote>
<p>isa 混写（isa-swizzling）isa：is a kind of ； swizzling：混合，搅合；</p>
</blockquote>
<p>来实现 KVO，当观察对象A时，KVO机制动态创建一个新的名为：</p>
<blockquote>
<p>NSKVONotifying_A 的继承自对象A的子类，</p>
</blockquote>
<p>且KVO为<code>NSKVONotifying_A</code>重写了观察属性的setter方法，setter方法会负责在调用原setter方法之前和之后，通知所有观察对象属性值的更改情况。</p>
<h3 id="NSKVONotifying-A类剖析："><a href="#NSKVONotifying-A类剖析：" class="headerlink" title="NSKVONotifying_A类剖析："></a>NSKVONotifying_A类剖析：</h3><p>在观察到对象成员有变化时，被观察对象的isa指针从指向原来的A类，被KVO机制修改为指向：</p>
<blockquote>
<p>系统新创建的子类 NSKVONotifying_A类，</p>
</blockquote>
<p>通过<code>NSKVONotifying_A</code>的setter方法来实现当前类属性值改变的监听；</p>
<p>所以当我们从应用层面上看来，完全没有意识到有新的类出现，这是系统隐瞒了对KVO的底层实现过程，让我们误以为还是原来的类。</p>
<p>但是此时如果我们创建一个新的名为<code>NSKVONotifying_A</code>的类，就会发现系统运行到注册KVO的那段代码时程序就崩溃，因为系统在注册监听的时候：</p>
<blockquote>
<p>动态的创建了名为NSKVONotifying_A的中间类，并指向这个中间类。</p>
</blockquote>
<p>因此由于类名的冲突，就会引起程序的崩溃。</p>
<h3 id="isa指针的作用："><a href="#isa指针的作用：" class="headerlink" title="isa指针的作用："></a>isa指针的作用：</h3><p>每个对象都有isa指针，指向该对象的类，它告诉Runtime系统这个对象的类是什么。所以对象注册为观察者时，isa指针指向新子类，那么：</p>
<blockquote>
<p>这个被观察的对象就神奇地变成新子类的对象或者说实例了。</p>
</blockquote>
<p>因此在该对象上对sette 的调用就会调用已重写的 setter，从而激活键值通知机制。</p>
<h3 id="子类setter方法剖析："><a href="#子类setter方法剖析：" class="headerlink" title="子类setter方法剖析："></a>子类setter方法剖析：</h3><p>KVO的键值观察通知依赖于NSObject 的两个方法：</p>
<blockquote>
<p>willChangeValueForKey:</p>
<p>didChangevlueForKey:</p>
</blockquote>
<ul>
<li><p>被观察属性发生<strong>改变之前</strong>，<code>willChangeValueForKey:</code>被调用，通知系统该 keyPath的属性值即将变更；</p>
<ul>
<li><p>当<strong>改变发生后</strong>， <code>didChangeValueForKey:</code>被调用，通知系统该keyPath的属性值已经变更；</p>
<ul>
<li><p>在上面的方法执行之后：</p>
<blockquote>
<p>observeValueForKey:ofObject:change:context: </p>
</blockquote>
<p>也会被调用。且重写观察属性的setter方法是在<strong>运行时</strong>而不是<strong>编译时</strong>实现的。</p>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>KVO为子类的观察者属性重写调用存取方法的工作原理在代码中相当于：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">-(void)setName:(NSString *)newName&#123; </div><div class="line">[self willChangeValueForKey:@&quot;name&quot;];    //KVO在调用存取方法之前总调用 </div><div class="line">[super setValue:newName forKey:@&quot;name&quot;]; //调用父类的存取方法 </div><div class="line">[self didChangeValueForKey:@&quot;name&quot;];     //KVO在调用存取方法之后总调用&#125;</div></pre></td></tr></table></figure>
<h2 id="KVO的主要方法"><a href="#KVO的主要方法" class="headerlink" title="KVO的主要方法"></a>KVO的主要方法</h2><p>KVO的主要方法有以下几个：</p>
<h3 id="addObserver调用方法"><a href="#addObserver调用方法" class="headerlink" title="addObserver调用方法"></a>addObserver调用方法</h3><figure class="highlight swift"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">object.addObserver(observer, forKeyPath: <span class="string">"name"</span>, options: <span class="number">0</span>, context: &amp;context)</div></pre></td></tr></table></figure>
<p><code>addObserver</code>方法用于添加观察者，监听属性的变化，它的几个参数作用如下：</p>
<ul>
<li>object：是被观察者的实例；</li>
<li>observer：是观察者的实例，这个对象要实现下面的<code>observeValue</code>方法；</li>
<li>forKeyPath：是观察者实例要监听的键，如UIView的frame、center等；</li>
<li>options：有4个值，5种情况，具体请看下文；</li>
<li>context：它是一个C指针，会指向希望监听的属性。如：<code>&amp;object-&gt;name</code>，同时它也可以带入一些参数，可以是任意类型，需要自己强转。</li>
</ul>
<h3 id="observeValue处理方法"><a href="#observeValue处理方法" class="headerlink" title="observeValue处理方法"></a>observeValue处理方法</h3><figure class="highlight swift"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">observeValue</span><span class="params">(forKeyPath keyPath: String?, of object: Any?, change: [NSKeyValueChangeKey : Any]?, context: UnsafeMutableRawPointer?)</span></span></div></pre></td></tr></table></figure>
<p><code>observeValue</code>方法用于监听属性的变化，使重写此方法的类具有监听的能力，它的几个参数作用如下：</p>
<ul>
<li>keyPath：对应forKeyPath</li>
<li>object：被观察的对象</li>
<li>change：对应options</li>
<li>context：对应context</li>
</ul>
<h3 id="removeObserver移除属性观察者"><a href="#removeObserver移除属性观察者" class="headerlink" title="removeObserver移除属性观察者"></a>removeObserver移除属性观察者</h3><figure class="highlight swift"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">object.removeObserver(observer, forKeyPath: <span class="string">"name"</span>, context: &amp;context)</div><div class="line">object.removeObserver(observer, forKeyPath: <span class="string">"name"</span>)</div></pre></td></tr></table></figure>
<p>需要注意的是，如果注册observer时传入了<code>context</code>，之后一定要在合适的机会解除，否则会引发资源泄露。</p>
<h3 id="options参数"><a href="#options参数" class="headerlink" title="options参数"></a>options参数</h3><p>options参数是<code>OptionSet</code>类型，它是一个结构体，有以下四个类型属性：</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">struct</span> <span class="title">NSKeyValueObservingOptions</span> : <span class="title">OptionSet</span> </span>&#123;</div><div class="line">    <span class="keyword">public</span> <span class="keyword">init</span>(rawValue: <span class="type">UInt</span>)</div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">var</span> new: <span class="type">NSKeyValueObservingOptions</span> &#123; <span class="keyword">get</span> &#125;</div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">var</span> old: <span class="type">NSKeyValueObservingOptions</span> &#123; <span class="keyword">get</span> &#125;</div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">var</span> initial: <span class="type">NSKeyValueObservingOptions</span> &#123; <span class="keyword">get</span> &#125;</div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">var</span> prior: <span class="type">NSKeyValueObservingOptions</span> &#123; <span class="keyword">get</span> &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>这四个值的含义如下：</p>
<h4 id="new："><a href="#new：" class="headerlink" title="new："></a>new：</h4><p>表明变化的字典应该提供新的属性值，接收方法中使用change参数传入变化后的新值，键为NSKeyValueChange.newKey；</p>
<h4 id="old："><a href="#old：" class="headerlink" title="old："></a>old：</h4><p>表明变化的字典应该包含旧的属性值，接收方法中使用change参数传入变化前的旧值；键为NSKeyValueChange.oldKey；</p>
<h4 id="initial："><a href="#initial：" class="headerlink" title="initial："></a>initial：</h4><p>把初始化的值提供给处理方法，一旦注册，马上就会调用一次，如果配置了new，change参数内容会包含新值；它是如何使用的呢？比如我们在进行UI相关的KVO操作时候，通常会遇到这样的需求：</p>
<blockquote>
<p>在添加通知后，立即发送一个改变通知告诉UI去更新界面。</p>
</blockquote>
<p>这会让我们的界面有一个初始状态。我们可以指定<code>Initial</code>选项，这样在我们添加完KVO监听后，属性改变的通知就会立即被执行一次：</p>
<h4 id="prior："><a href="#prior：" class="headerlink" title="prior："></a>prior：</h4><p>接收方法会在变化前后分别调用一次，共两次，change参数内容根据new和old的配置确定。这个选项可以让我们在被监听的属性改变的时候得到两个通知，一个是在属性值改变之前，一个是属性值改变之后。</p>
<p>然后就可以在 <code>observeValueForKeyPath</code>中的<code>change</code>字典中以<code>NSKeyValueChangeNotificationIsPriorKey</code>键来表示当前通知是不是在属性被修改之前发送的:</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">override</span> <span class="function"><span class="keyword">func</span> <span class="title">observeValueForKeyPath</span><span class="params">(keyPath: String?, ofObject object: AnyObject?, change: [String : AnyObject]?, context: UnsafeMutablePointer&lt;Void&gt;)</span></span> &#123;</div><div class="line">        </div><div class="line">  <span class="keyword">if</span> <span class="keyword">let</span> <span class="number">_</span> = change?[<span class="type">NSKeyValueChangeNotificationIsPriorKey</span>] &#123;</div><div class="line">    <span class="built_in">print</span>(<span class="string">"old"</span>)</div><div class="line">  &#125;</div><div class="line">  <span class="keyword">else</span> &#123;</div><div class="line">    <span class="built_in">print</span>(<span class="string">"new"</span>)            </div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>当然，如果你只是想得到修改前和修改后的值，那么也可以用<code>change</code>字段中的<code>NSKeyValueChangeOldKey</code>和 <code>NSKeyValueChangeNewKey</code>来得到相应的值：</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">if</span> <span class="keyword">let</span> newFirstName = change?[<span class="type">NSKeyValueChangeNewKey</span>] <span class="keyword">as</span>? <span class="type">String</span> &#123;</div><div class="line">                </div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">if</span> <span class="keyword">let</span> oldFirstName = change?[<span class="type">NSKeyValueChangeOldKey</span>] <span class="keyword">as</span>? <span class="type">String</span> &#123;</div><div class="line">                </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="change参数"><a href="#change参数" class="headerlink" title="change参数"></a>change参数</h3><p>change参数是<code>NSKeyValueChangeKey</code>类型，它是一个结构体：</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">struct</span> <span class="title">NSKeyValueChangeKey</span> : <span class="title">RawRepresentable</span>, <span class="title">Equatable</span>, <span class="title">Hashable</span>, <span class="title">Comparable</span> </span>&#123;</div><div class="line">    <span class="keyword">public</span> <span class="keyword">init</span>(rawValue: <span class="type">String</span>)</div><div class="line">&#125;</div><div class="line"><span class="class"><span class="keyword">extension</span> <span class="title">NSKeyValueChangeKey</span> </span>&#123;</div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">let</span> kindKey: <span class="type">NSKeyValueChangeKey</span></div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">let</span> newKey: <span class="type">NSKeyValueChangeKey</span></div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">let</span> oldKey: <span class="type">NSKeyValueChangeKey</span></div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">let</span> indexesKey: <span class="type">NSKeyValueChangeKey</span></div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">let</span> notificationIsPriorKey: <span class="type">NSKeyValueChangeKey</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>它的几个参数作用如下：</p>
<ul>
<li><p>kindKey：用于传递被监听属性的变化类型</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">enum</span> <span class="title">NSKeyValueChange</span> : <span class="title">UInt</span> </span>&#123;</div><div class="line">    <span class="keyword">case</span> setting</div><div class="line">    <span class="keyword">case</span> insertion</div><div class="line">    <span class="keyword">case</span> removal</div><div class="line">    <span class="keyword">case</span> replacement</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>setting：属性的值被重新设置；</li>
<li>insertion &amp; removal &amp; replacement：表示更改的是集合属性，分别代表插入、删除、替换操作。</li>
</ul>
</li>
<li><p>newKey：如果KindKey是setting，那么newKey对应的为新设置的值；</p>
</li>
<li><p>oldKey：如果KindKey是setting，那么oldkey对应的为上一个值；</p>
</li>
<li><p>indexesKey：如果kindkey是.insertion, .removal, .replacement，那么这个值对应的为NSIndexSet (包含相应操作的indexs)；</p>
</li>
<li><p>priorKey：表明收到的是值改变之前的通知，对应着addobserver中option的.prior；</p>
</li>
</ul>
<p>了解KVO的主要方法和参数后，我们就可以开始使用KVO进行编程了，下面我们开始进行：</p>
<h2 id="KVO的使用"><a href="#KVO的使用" class="headerlink" title="KVO的使用"></a>KVO的使用</h2><p>首先定义一个 <code>Persson</code> 类，当做被观察的对象：</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Person</span>: <span class="title">NSObject</span> </span>&#123;</div><div class="line">    <span class="keyword">var</span> address: <span class="type">String</span>?</div><div class="line">    <span class="keyword">var</span> weight: <span class="type">Float</span>?</div><div class="line">    <span class="keyword">var</span> name: <span class="type">String</span>?</div><div class="line">    <span class="keyword">var</span> age: <span class="type">Int</span>?</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>再定义一个 <code>PersonObserving</code> 类并重写<code>observeValue</code>方法，用于观察<code>Person</code>：</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">PersonObserving</span>: <span class="title">NSObject</span> </span>&#123;</div><div class="line">    </div><div class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">func</span> <span class="title">observeValue</span><span class="params">(forKeyPath keyPath: String?,</span></span></div><div class="line">                               of object: Any?,</div><div class="line">                               change: [NSKeyValueChangeKey : Any]?,</div><div class="line">                               context: UnsafeMutableRawPointer?) &#123;</div><div class="line">        </div><div class="line">        <span class="keyword">let</span> newValue = change?[<span class="type">NSKeyValueChangeKey</span>.newKey]</div><div class="line">        <span class="keyword">let</span> oldValue = change?[<span class="type">NSKeyValueChangeKey</span>.oldKey]</div><div class="line">        </div><div class="line">        <span class="keyword">let</span> person = object <span class="keyword">as</span>! <span class="type">Person</span></div><div class="line">        <span class="keyword">let</span> con = context?.load(<span class="keyword">as</span>: <span class="type">String</span>.<span class="keyword">self</span>)</div><div class="line">        <span class="built_in">print</span>(<span class="string">"观察到<span class="subst">\(keyPath)</span>的变化，旧的值是<span class="subst">\(oldValue)</span>,新的值是<span class="subst">\(newValue)</span>"</span>)</div><div class="line">        <span class="built_in">print</span>(<span class="string">"观察的类是<span class="subst">\(type(of: person)</span>)"</span>)</div><div class="line">        <span class="built_in">print</span>(<span class="string">"接收的上下文是<span class="subst">\(con)</span>"</span>)</div><div class="line"></div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>观察者和被观察者准备就绪，即可进行测试：</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**执行*/</span></div><div class="line"><span class="keyword">let</span> person = <span class="type">Person</span>()</div><div class="line"><span class="keyword">let</span> personObserving = <span class="type">PersonObserving</span>()</div><div class="line"><span class="keyword">var</span> context = <span class="string">"this is a context"</span></div><div class="line"></div><div class="line">person.addObserver(personObserving,</div><div class="line">                   forKeyPath: <span class="string">"name"</span>,</div><div class="line">                   options: <span class="type">NSKeyValueObservingOptions</span>.new,</div><div class="line">                   context: &amp;context)</div><div class="line"></div><div class="line">person.setValue(<span class="string">"Jerk ass"</span>, forKey: <span class="string">"name"</span>)</div><div class="line"><span class="built_in">print</span>(person.value(forKey: <span class="string">"name"</span>))</div><div class="line"></div><div class="line">person.removeObserver(personObserving,</div><div class="line">                      forKeyPath: <span class="string">"name"</span>,</div><div class="line">                      context: &amp;context)</div><div class="line">                      </div><div class="line"><span class="comment">/**输出*/</span></div><div class="line">观察到<span class="type">Optional</span>(<span class="string">"name"</span>)的变化，旧的值是<span class="literal">nil</span>,新的值是<span class="type">Optional</span>(<span class="type">Jerk</span> ass)</div><div class="line">观察的类是<span class="type">Person</span></div><div class="line">接收的上下文是<span class="type">Optional</span>(<span class="string">"this is a context"</span>)</div><div class="line"><span class="type">Optional</span>(<span class="type">Jerk</span> ass)</div></pre></td></tr></table></figure>
<h2 id="KVO和keyPath"><a href="#KVO和keyPath" class="headerlink" title="KVO和keyPath"></a>KVO和keyPath</h2><p>如果<code>Person</code>类里面还有个再添加一个<code>Job</code>的属性：</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Person</span>: <span class="title">NSObject</span> </span>&#123;</div><div class="line">    </div><div class="line">    <span class="keyword">var</span> address: <span class="type">String</span>?</div><div class="line">    <span class="keyword">var</span> weight: <span class="type">Float</span>?</div><div class="line">    <span class="keyword">var</span> name: <span class="type">String</span>?</div><div class="line">    <span class="keyword">var</span> age: <span class="type">Int</span>?</div><div class="line">    </div><div class="line">    <span class="keyword">var</span> job = <span class="type">Job</span>()</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Job</span>: <span class="title">NSObject</span> </span>&#123;</div><div class="line">    <span class="keyword">var</span> companyName: <span class="type">String</span>?</div><div class="line">    <span class="keyword">var</span> salary: <span class="type">NSNumber</span>?</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">/**执行*/</span></div><div class="line">person.addObserver(personObserving, forKeyPath: <span class="string">"job.salary"</span>,</div><div class="line">                   options: <span class="type">NSKeyValueObservingOptions</span>.new,</div><div class="line">                   context: &amp;context)</div><div class="line">person.setValue(<span class="string">"20000.00"</span>, forKeyPath: <span class="string">"job.salary"</span>)</div><div class="line"><span class="built_in">print</span>(person.value(forKeyPath: <span class="string">"job.salary"</span>))</div><div class="line"></div><div class="line">person.removeObserver(personObserving,</div><div class="line">                      forKeyPath: <span class="string">"job.salary"</span>,</div><div class="line">                      context: &amp;context)</div><div class="line">                      </div><div class="line"><span class="comment">/**输出*/</span></div><div class="line">观察到<span class="type">Optional</span>(<span class="string">"job.salary"</span>)的变化，旧的值是<span class="literal">nil</span>,新的值是<span class="type">Optional</span>(<span class="number">20000.00</span>)</div><div class="line">观察的类是<span class="type">Person</span></div><div class="line">接收的上下文是<span class="type">Optional</span>(<span class="string">"this is a context"</span>)</div><div class="line"><span class="type">Optional</span>(<span class="number">20000.00</span>)</div></pre></td></tr></table></figure>
<p>要观察和设置<code>Person</code>的薪水，只要这么写就可以了。</p>
<h2 id="KVO属性依赖"><a href="#KVO属性依赖" class="headerlink" title="KVO属性依赖"></a>KVO属性依赖</h2><p>假如有个<code>Person</code>类，类里有三个属性，<code>fullName</code>、<code>firstName</code>、<code>lastName</code>。按照之前的知识，如果需要观察名字的变化，就要分别添加 <code>fullName</code>、<code>firstName</code>、<code>lastName</code> 三次观察，非常麻烦。</p>
<p>如果能够只观察 <code>fullName</code>，并建立<code>fullName</code> 和 <code>firstName</code>、<code>lastName</code> 的某种依赖关系，当发生变化时，也受到通知，那需要怎么做呢？KVC提供这种键之间的依赖方法，格式如下：</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">func</span> <span class="title">keyPathsForValuesAffecting</span>&lt;<span class="title">Key</span>&gt;() -&gt; <span class="title">NSSet</span></span></div></pre></td></tr></table></figure>
<p>这方法使得Key之间能够建立依赖关系，为了便于说明，直接用<strong>属性依赖</strong>这个词代替Key之间的依赖。含义不同，结果一致，下面就使用这种方法解决 Key 之间的依赖关系，首先将<code>Person</code>类设置为被观察者：</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Person</span>: <span class="title">NSObject</span> </span>&#123;</div><div class="line">    </div><div class="line">    <span class="keyword">var</span> firstName: <span class="type">String</span>?</div><div class="line">    <span class="keyword">var</span> lastName: <span class="type">String</span>?</div><div class="line">    <span class="keyword">var</span> fullName: <span class="type">String</span>? &#123;</div><div class="line">        <span class="keyword">get</span> &#123;</div><div class="line">            <span class="keyword">return</span> firstName! + lastName!</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    </div><div class="line">    <span class="keyword">override</span> <span class="class"><span class="keyword">class</span> <span class="title">func</span> <span class="title">keyPathsForValuesAffectingValue</span>(<span class="title">forKey</span> <span class="title">key</span>: <span class="title">String</span>) -&gt; <span class="title">Set</span>&lt;<span class="title">String</span>&gt; </span>&#123;</div><div class="line">        <span class="built_in">print</span>(#function)</div><div class="line">        </div><div class="line">        <span class="keyword">if</span> key == <span class="string">"fullName"</span> &#123;</div><div class="line">            </div><div class="line">            <span class="keyword">return</span> <span class="type">Set</span>&lt;<span class="type">String</span>&gt;(arrayLiteral: <span class="string">"firstName"</span>,<span class="string">"lastName"</span>)</div><div class="line">            </div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            </div><div class="line">            <span class="keyword">return</span> <span class="keyword">super</span>.keyPathsForValuesAffectingValue(forKey: key)</div><div class="line">            </div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>将<code>ViewController</code> 类设置为观察者：</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">ViewController</span>: <span class="title">UIViewController</span> </span>&#123;</div><div class="line">   </div><div class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">func</span> <span class="title">observeValue</span><span class="params">(forKeyPath keyPath: String?,</span></span></div><div class="line">                               of object: Any?,</div><div class="line">                               change: [NSKeyValueChangeKey : Any]?,</div><div class="line">                               context: UnsafeMutableRawPointer?) &#123;</div><div class="line">        </div><div class="line">        <span class="keyword">let</span> newValue = change?[<span class="type">NSKeyValueChangeKey</span>.newKey]</div><div class="line">        <span class="keyword">let</span> oldValue = change?[<span class="type">NSKeyValueChangeKey</span>.oldKey]</div><div class="line">        <span class="built_in">print</span>(<span class="string">"观察到<span class="subst">\(keyPath)</span>的变化，旧的值是<span class="subst">\(oldValue)</span>,新的值是<span class="subst">\(newValue)</span>"</span>)</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">/**执行*/</span></div><div class="line"><span class="keyword">let</span> person = <span class="type">Person</span>()</div><div class="line">person.lastName = <span class="string">"hoohoo"</span></div><div class="line"><span class="keyword">var</span> context = <span class="string">"this is a context"</span></div><div class="line">person.addObserver(<span class="keyword">self</span>,</div><div class="line">                   forKeyPath: <span class="string">"fullName"</span>,</div><div class="line">                   options: <span class="type">NSKeyValueObservingOptions</span>.new,</div><div class="line">                   context: &amp;context)</div><div class="line">person.setValue(<span class="string">"Bad ass "</span>, forKeyPath: <span class="string">"firstName"</span>)</div><div class="line">person.removeObserver(<span class="keyword">self</span>, forKeyPath: <span class="string">"fullName"</span>, context: &amp;context)</div><div class="line"><span class="built_in">print</span>(person.value(forKeyPath: <span class="string">"fullName"</span>))</div><div class="line"></div><div class="line"><span class="comment">/**输出*/</span></div><div class="line">keyPathsForValuesAffectingValue(forKey:)</div><div class="line">keyPathsForValuesAffectingValue(forKey:)</div><div class="line">keyPathsForValuesAffectingValue(forKey:)</div><div class="line">keyPathsForValuesAffectingValue(forKey:)</div><div class="line">keyPathsForValuesAffectingValue(forKey:)</div><div class="line">观察到<span class="type">Optional</span>(<span class="string">"fullName"</span>)的变化，旧的值是<span class="literal">nil</span>,新的值是<span class="type">Optional</span>(<span class="type">Bad</span> ass hoohoo)</div><div class="line"><span class="type">Optional</span>(<span class="type">Bad</span> ass hoohoo)</div></pre></td></tr></table></figure>
<p>通过输出结果，我们可以判断出：发现虽然观察的是<code>fullName</code>，但是当修改<code>firstName</code>的时候，观察者也会收到<code>fullName</code>变化的通知，达到了我们的期望。</p>
<p>重写<code>keyPathsForValuesAffectingValueForKey</code>方法的时候有一点需要注意，这个方法在Objective-C中的签名是这样：</p>
<blockquote>
<p>(NSSet <em>)keyPathsForValuesAffectingValueForKey:(NSString </em>)key；</p>
</blockquote>
<p>如果照着这个逻辑，我们很可能在 Swift 中将这个方法的声明写成这样：</p>
<blockquote>
<p>override class func keyPathsForValuesAffectingValueForKey(key: NSString) -&gt; NSSet；</p>
</blockquote>
<p>如果这样写，编译器就会报错。因为Swift 中将Objective-C的一些基础类型都已经转变成了Swift的原生类型，所以我们这个方法签名要写成这样才可以通过编译：</p>
<blockquote>
<p>override class func keyPathsForValuesAffectingValueForKey(key: String) -&gt; Set。</p>
</blockquote>
<h2 id="KVO手动通知"><a href="#KVO手动通知" class="headerlink" title="KVO手动通知"></a>KVO手动通知</h2><p>KVO 在默认情况下，只要为某个属性添加了监听对象，在这个属性值改变的时候，就会自动的通知监听者。也有一些情况下，可能我们想手动的处理这些通知的发送， KVO 也是允许我们这样做的。我们可以通过重写</p>
<blockquote>
<p>class func automaticallyNotifiesObservers(forKey key:String) -&gt; Bool</p>
</blockquote>
<p>这个方法告诉KVO，哪些属性是我们想手动处理的，比如我们的Person类中，想对<code>firstName</code>进行处理，就在方法中对<code>firstName</code>这个key返回<code>false</code>：</p>
<h3 id="dynamic关键字"><a href="#dynamic关键字" class="headerlink" title="dynamic关键字"></a>dynamic关键字</h3><p>注意下面我们使用了<code>dynamic</code>标识。这个代表它支持Objective-C Runtime的动态分发机制，我们这里可以理解为 KVO需要使用Objective-C的Runtime机制来实现属性更改的监听。 </p>
<p>Swift中的属性处于性能等方面的考虑默认是关闭动态分发的，所以我们这里面要显式的将属性用<code>dynamic</code>关键字标识出来。</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Person</span>: <span class="title">NSObject</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">dynamic</span> <span class="keyword">var</span> firstName: <span class="type">String</span>? &#123;</div><div class="line">        <span class="keyword">willSet</span> &#123;</div><div class="line">            <span class="built_in">print</span>(<span class="string">"<span class="subst">\(#function)</span> 将要修改，现在的值是 <span class="subst">\(newValue)</span>"</span>)</div><div class="line">            <span class="keyword">self</span>.willChangeValue(forKey: <span class="string">"firstName"</span>)</div><div class="line"></div><div class="line">        &#125;</div><div class="line">        <span class="keyword">didSet</span> &#123;</div><div class="line">            <span class="keyword">self</span>.didChangeValue(forKey: <span class="string">"firstName"</span>)</div><div class="line">            <span class="built_in">print</span>(<span class="string">"<span class="subst">\(#function)</span> 已修改，原来的值是 <span class="subst">\(oldValue)</span>"</span>)</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">func</span> <span class="title">willChangeValue</span><span class="params">(forKey key: String)</span></span> &#123;</div><div class="line">        <span class="built_in">print</span>(<span class="string">"<span class="subst">\(key)</span> 将要修改"</span>)</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">func</span> <span class="title">didChangeValue</span><span class="params">(forKey key: String)</span></span> &#123;</div><div class="line">         <span class="built_in">print</span>(<span class="string">"<span class="subst">\(key)</span> 已修改"</span>)</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="keyword">override</span> <span class="class"><span class="keyword">class</span> <span class="title">func</span> <span class="title">automaticallyNotifiesObservers</span>(<span class="title">forKey</span> <span class="title">key</span>:<span class="title">String</span>) -&gt; <span class="title">Bool</span> </span>&#123;</div><div class="line">        </div><div class="line">        <span class="keyword">if</span> key == <span class="string">"firstName"</span> &#123;</div><div class="line">            <span class="keyword">return</span> <span class="literal">false</span></div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            <span class="keyword">return</span> <span class="literal">true</span></div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">/**执行*/</span></div><div class="line"><span class="keyword">let</span> person = <span class="type">Person</span>()</div><div class="line"><span class="keyword">var</span> context = <span class="string">"this is a context"</span></div><div class="line">person.addObserver(<span class="keyword">self</span>,</div><div class="line">                   forKeyPath: <span class="string">"firstName"</span>,</div><div class="line">                   options: <span class="type">NSKeyValueObservingOptions</span>.new,</div><div class="line">                   context: &amp;context)</div><div class="line">person.setValue(<span class="string">"Bad ass "</span>, forKeyPath: <span class="string">"firstName"</span>)</div><div class="line">person.removeObserver(<span class="keyword">self</span>, forKeyPath: <span class="string">"firstName"</span>, context: &amp;context)</div><div class="line"><span class="built_in">print</span>(person.value(forKeyPath: <span class="string">"firstName"</span>))</div><div class="line"></div><div class="line"><span class="comment">/**输出*/</span></div><div class="line">keyPathsForValuesAffectingValue(forKey:)</div><div class="line">firstName 将要修改，现在的值是 <span class="type">Optional</span>(<span class="string">"Bad ass "</span>)</div><div class="line">firstName 将要修改</div><div class="line">firstName 已修改</div><div class="line">firstName 已修改，原来的值是 <span class="literal">nil</span></div><div class="line"><span class="type">Optional</span>(<span class="type">Bad</span> ass )</div></pre></td></tr></table></figure>
<p>这样，我们在修改了<code>fistName</code>属性值后，并不会触发KVO的默认通知行为，是我们自己来控制通知的发送，当然，这需要我们修改<code>firstName</code>属性的实现来进行手工的通知发送，手动通知能让我们对KVO通知进行更细节的控制。但并不常用，大多数情况下使用KVO的自动通知机制就足够了。</p>
<h2 id="KVO和线程"><a href="#KVO和线程" class="headerlink" title="KVO和线程"></a>KVO和线程</h2><p>一个需要注意的地方是，KVO 行为是同步的，并且发生与所观察的值发生变化的同样的线程上。没有队列或者 Run-loop 的处理。手动或者自动调用<code>-didChange...</code>会触发 KVO 通知。</p>
<p>所以，当我们试图从其他线程改变属性值的时候我们应当十分小心，除非能确定所有的观察者都用线程安全的方法处理 KVO 通知。通常来说，我们不推荐把KVO和多线程混起来。如果我们要用多个队列和线程，我们不应该在它们互相之间用 KVO。</p>
<p>KVO是同步运行的这个特性非常强大，只要我们在单一线程上面运行（比如主队列 main queue），KVO会保证下列两种情况的发生：</p>
<ul>
<li><p>首先，如果我们调用一个支持KVO的setter方法，如下所示：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">self.name = &quot;conqueror&quot;</div></pre></td></tr></table></figure>
<p>KVO能保证所有<code>name</code>的观察者在<code>setter</code>方法返回前被通知到。</p>
</li>
<li><p>其次，如果某个键被观察的时候附上了<code>NSKeyValueObservingOptionPrior</code>这个选项，直到</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">override</span> <span class="function"><span class="keyword">func</span> <span class="title">observeValue</span><span class="params">(forKeyPath keyPath: String?, of object: Any?, change: [NSKeyValueChangeKey : Any]?, context: UnsafeMutableRawPointer?)</span></span></div></pre></td></tr></table></figure>
<p>被调用之前， <code>name</code>的<code>getter</code>方法都会返回同样的值。</p>
<p>​</p>
</li>
</ul>
<h2 id="理解KVO的实现"><a href="#理解KVO的实现" class="headerlink" title="理解KVO的实现"></a>理解KVO的实现</h2><p>基本的流程就是编译器自动为被观察对象创造一个派生类，并将被观察对象的isa指向这个派生类。如果用户注册了对某此目标对象的某一个属性的观察，那么此派生类会重写这个方法，并在其中添加进行通知的代码。</p>
<p>Objective-C在发送消息的时候，会通过isa指针找到当前对象所属的类对象。而类对象中保存着当前对象的实例方法，因此在向此对象发送消息时候，实际上是发送到了派生类对象的方法。</p>
<p>由于编译器对派生类的方法进行了override，并添加了通知代码，因此会向注册的对象发送通知。注意派生类只重写注册了观察者的属性方法。</p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>KVO是Cocoa提供的一个很强大的特性，但同时它也有很多坑需要我们注意，比如添加完监听后，要在不需要的时候删除掉监听，否则就会造成意外崩溃。对于有依赖关系的属性需要通过：</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">override</span> <span class="class"><span class="keyword">class</span> <span class="title">func</span> <span class="title">keyPathsForValuesAffectingValue</span>(<span class="title">forKey</span> <span class="title">key</span>: <span class="title">String</span>) -&gt; <span class="title">Set</span></span></div></pre></td></tr></table></figure>
<p>这个方法将依赖关系声明到实体类中。还有各个监听选项的作用不同组合也有不同的作用；</p>
<p>另外需要注意的是观察者观察的是属性，只有遵循KVO变更属性值的方式才会执行KVO的回调方法，<strong>例如是否执行了setter方法、或者是否使用了KVC赋值。</strong></p>
<p>如果赋值没有通过setter方法或者KVC，而是直接修改属性对应的成员变量，例如：仅调用<code>person.name =  &quot;newName&quot;</code>，这时是不会触发KVO机制，所以使用KVO机制的前提是遵循 KVO 的属性设置方式来变更属性值。</p>
<p>对比其他的回调方式，KVO机制的运用的实现，更多的由系统支持，相比Notification、Delegate等更简洁些，并且能够提供观察属性的最新值以及原始值；但是相应的在创建子类、重写方法等等方面的内存消耗是很巨大的。</p>
<p>由于KVO对被观察者的继承和重写是在运行时而不是编译时实现的，如果给定的实例没有观察者，那么KVO不会有任何开销，因为此时根本就没有KVO代码存在。但是即使没有观察者，Delegate和NSNotification还是得工作，这也是KVO此处零开销观察的优势。</p>
<p>所以对于两个类之间的通信，我们可以根据实际开发的环境采用不同的方法，使得开发的项目更加简洁实用。 </p>
<h3 id="KVC与KVO的区别"><a href="#KVC与KVO的区别" class="headerlink" title="KVC与KVO的区别"></a>KVC与KVO的区别</h3><p>KVC(键值编码)，即Key-Value Coding，一个非正式的Protocol，使用字符串(键)访问一个对象实例变量的机制。而不是通过调用Setter、Getter方法等显式的存取方式去访问。<br>KVO(键值监听)，即Key-Value Observing，它提供一种机制，当指定的对象的属性被修改后，对象就会接受到通知，前提是执行了Setter方法、或者使用了KVC赋值。</p>
<h3 id="KVO与Notification的区别"><a href="#KVO与Notification的区别" class="headerlink" title="KVO与Notification的区别"></a>KVO与Notification的区别</h3><p>Notification比KVO多了发送通知的一步，两者都是一对多，但是对象之间直接的交互，Notification需要NotificationCenter来做为中间交互。而KVO如我们介绍的，设置观察者-&gt;处理属性变化，至于中间通知这一环，则隐秘多了。</p>
<p>Notification的优点是监听不局限于属性的变化，还可以对多种多样的状态变化进行监听，监听范围广，例如键盘、前后台等系统通知的使用也更显灵活方便。</p>
<h3 id="KVO与Delegate的区别"><a href="#KVO与Delegate的区别" class="headerlink" title="KVO与Delegate的区别"></a>KVO与Delegate的区别</h3><p>和Delegate一样，KVO和NSNotification的作用都是类与类之间的通信。</p>
<p>但是KVO和NSNotification与Delegate不同的是，KVO和NSNotification都是负责发送接收通知，剩下的事情由系统处理，所以不用返回值；</p>
<p>而Delegate则需要通信的对象通过变量(代理)联系；Delegate一般是一对一，而KVO和NSNotification可以一对多。</p>
<h2 id="参考链接"><a href="#参考链接" class="headerlink" title="参考链接"></a>参考链接</h2><p><a href="https://www.objccn.io/issue-7-3/" target="_blank" rel="external">KVC和KVO</a> -  卢思豪</p>
<p><a href="http://www.jianshu.com/p/e59bb8f59302" target="_blank" rel="external">iOS–KVO的实现原理与具体应用</a> - 啊左</p>
<p><a href="http://swiftcafe.io/2016/01/03/kvc/" target="_blank" rel="external">漫谈 KVC 与 KVO</a> - SwiftCafe</p>
<h2 id="Demo下载请点击这里"><a href="#Demo下载请点击这里" class="headerlink" title="Demo下载请点击这里"></a>Demo下载请<a href="https://github.com/tianziyao/KeyValueObserving" target="_blank" rel="external">点击这里</a></h2>
      
    </div>

    <div>
      
        

      
    </div>

    <div>
      
        

      
    </div>

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/设计模式/" rel="tag">#设计模式</a>
          
            <a href="/tags/KVO/" rel="tag">#KVO</a>
          
        </div>
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2016/09/21/iOS设计模式 - KVC内部机制/" rel="next" title="iOS设计模式 - KVC内部机制&使用场景">
                <i class="fa fa-chevron-left"></i> iOS设计模式 - KVC内部机制&使用场景
              </a>
            
          </div>

          <div class="post-nav-prev post-nav-item">
            
          </div>
        </div>
      

      
      
    </footer>
  </article>



    <div class="post-spread">
      
        <div class="ds-share flat" data-thread-key="2016/09/23/KVO/"
     data-title="iOS设计模式 - KVO原理和使用"
     data-content=""
     data-url="http://yoursite.com/2016/09/23/KVO/">
  <div class="ds-share-inline">
    <ul  class="ds-share-icons-16">

      <li data-toggle="ds-share-icons-more"><a class="ds-more" href="javascript:void(0);">分享到：</a></li>
      <li><a class="ds-weibo" href="javascript:void(0);" data-service="weibo">微博</a></li>
      <li><a class="ds-qzone" href="javascript:void(0);" data-service="qzone">QQ空间</a></li>
      <li><a class="ds-qqt" href="javascript:void(0);" data-service="qqt">腾讯微博</a></li>
      <li><a class="ds-wechat" href="javascript:void(0);" data-service="wechat">微信</a></li>

    </ul>
    <div class="ds-share-icons-more">
    </div>
  </div>
</div>
      
    </div>
  </div>


          </div>
          


          
  <div class="comments" id="comments">
    
      <div class="ds-thread" data-thread-key="2016/09/23/KVO/"
           data-title="iOS设计模式 - KVO原理和使用" data-url="http://yoursite.com/2016/09/23/KVO/">
      </div>
    
  </div>


        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap" >
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview sidebar-panel ">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="http://ob2q6r0fn.bkt.clouddn.com/touxiang.jpg"
               alt="iSTian" />
          <p class="site-author-name" itemprop="name">iSTian</p>
          <p class="site-description motion-element" itemprop="description">不积跬步，无以至千里。<br>不积小流，无以成江海。</p>
        </div>
        <nav class="site-state motion-element">
          <div class="site-state-item site-state-posts">
            <a href="/archives">
              <span class="site-state-item-count">49</span>
              <span class="site-state-item-name">日志</span>
            </a>
          </div>

          
            <div class="site-state-item site-state-categories">
              <a href="/categories">
                <span class="site-state-item-count">9</span>
                <span class="site-state-item-name">分类</span>
              </a>
            </div>
          

          
            <div class="site-state-item site-state-tags">
              <a href="/tags">
                <span class="site-state-item-count">65</span>
                <span class="site-state-item-name">标签</span>
              </a>
            </div>
          

        </nav>

        
          <div class="feed-link motion-element">
            <a href="/atom.xml" rel="alternate">
              <i class="fa fa-rss"></i>
              RSS
            </a>
          </div>
        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
                <a href="https://github.com/tianziyao" target="_blank" title="GitHub">
                  
                    <i class="fa fa-fw fa-github"></i>
                  
                  GitHub
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="http://weibo.com/2646913484" target="_blank" title="Weibo">
                  
                    <i class="fa fa-fw fa-weibo"></i>
                  
                  Weibo
                </a>
              </span>
            
          
        </div>

        
        

        
        

      </section>

      
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">
            
              
            
            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#实现原理"><span class="nav-number">1.</span> <span class="nav-text">实现原理</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#NSKVONotifying-A类剖析："><span class="nav-number">1.1.</span> <span class="nav-text">NSKVONotifying_A类剖析：</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#isa指针的作用："><span class="nav-number">1.2.</span> <span class="nav-text">isa指针的作用：</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#子类setter方法剖析："><span class="nav-number">1.3.</span> <span class="nav-text">子类setter方法剖析：</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#KVO的主要方法"><span class="nav-number">2.</span> <span class="nav-text">KVO的主要方法</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#addObserver调用方法"><span class="nav-number">2.1.</span> <span class="nav-text">addObserver调用方法</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#observeValue处理方法"><span class="nav-number">2.2.</span> <span class="nav-text">observeValue处理方法</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#removeObserver移除属性观察者"><span class="nav-number">2.3.</span> <span class="nav-text">removeObserver移除属性观察者</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#options参数"><span class="nav-number">2.4.</span> <span class="nav-text">options参数</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#new："><span class="nav-number">2.4.1.</span> <span class="nav-text">new：</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#old："><span class="nav-number">2.4.2.</span> <span class="nav-text">old：</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#initial："><span class="nav-number">2.4.3.</span> <span class="nav-text">initial：</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#prior："><span class="nav-number">2.4.4.</span> <span class="nav-text">prior：</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#change参数"><span class="nav-number">2.5.</span> <span class="nav-text">change参数</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#KVO的使用"><span class="nav-number">3.</span> <span class="nav-text">KVO的使用</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#KVO和keyPath"><span class="nav-number">4.</span> <span class="nav-text">KVO和keyPath</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#KVO属性依赖"><span class="nav-number">5.</span> <span class="nav-text">KVO属性依赖</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#KVO手动通知"><span class="nav-number">6.</span> <span class="nav-text">KVO手动通知</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#dynamic关键字"><span class="nav-number">6.1.</span> <span class="nav-text">dynamic关键字</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#KVO和线程"><span class="nav-number">7.</span> <span class="nav-text">KVO和线程</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#理解KVO的实现"><span class="nav-number">8.</span> <span class="nav-text">理解KVO的实现</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#总结"><span class="nav-number">9.</span> <span class="nav-text">总结</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#KVC与KVO的区别"><span class="nav-number">9.1.</span> <span class="nav-text">KVC与KVO的区别</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#KVO与Notification的区别"><span class="nav-number">9.2.</span> <span class="nav-text">KVO与Notification的区别</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#KVO与Delegate的区别"><span class="nav-number">9.3.</span> <span class="nav-text">KVO与Delegate的区别</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#参考链接"><span class="nav-number">10.</span> <span class="nav-text">参考链接</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Demo下载请点击这里"><span class="nav-number">11.</span> <span class="nav-text">Demo下载请点击这里</span></a></li></ol></div>
            
          </div>
        </section>
      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy; 
  <span itemprop="copyrightYear">2016</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">iSTian</span>
</div>

<div class="powered-by">
  由 <a class="theme-link" href="https://hexo.io">Hexo</a> 强力驱动
</div>

<div class="theme-info">
  主题 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Pisces
  </a>
</div>

        

        
      </div>
    </footer>

    <div class="back-to-top">
      <i class="fa fa-arrow-up"></i>
    </div>
  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  



  
  <script type="text/javascript" src="/vendors/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/vendors/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/vendors/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/vendors/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/vendors/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/vendors/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.0.1"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.0.1"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.0.1"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.0.1"></script>



  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.0.1"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.0.1"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.0.1"></script>



  

  
    
  

  <script type="text/javascript">
    var duoshuoQuery = {short_name:"tianziyao"};
    (function() {
      var ds = document.createElement('script');
      ds.type = 'text/javascript';ds.async = true;
      ds.id = 'duoshuo-script';
      ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
      ds.charset = 'UTF-8';
      (document.getElementsByTagName('head')[0]
      || document.getElementsByTagName('body')[0]).appendChild(ds);
    })();
  </script>

  
    
    <script src="/vendors/ua-parser-js/dist/ua-parser.min.js?v=0.7.9"></script>
    <script src="/js/src/hook-duoshuo.js"></script>
  






  
  

  

  

  

</body>
</html>
